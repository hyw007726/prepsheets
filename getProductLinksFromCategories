import * as functions from 'firebase-functions';
import { promises as fsPromises } from 'fs';
import puppeteer from 'puppeteer';


const string = `{"beef":"https://order.syscoireland.com/catalog/category/view/s/beef/id/10796/","chicken":"https://order.syscoireland.com/catalog/category/view/s/chicken/id/10583/","bacon-rashers":"https://order.syscoireland.com/catalog/category/view/s/bacon-rashers/id/10769/","lamb":"https://order.syscoireland.com/catalog/category/view/s/lamb/id/10799/","sausages":"https://order.syscoireland.com/catalog/category/view/s/sausages/id/10730/","pork":"https://order.syscoireland.com/catalog/category/view/s/pork/id/10745/","turkey":"https://order.syscoireland.com/catalog/category/view/s/turkey/id/10526/","duck":"https://order.syscoireland.com/catalog/category/view/s/duck/id/10835/","puddings":"https://order.syscoireland.com/catalog/category/view/s/puddings/id/10766/","veal":"https://order.syscoireland.com/catalog/category/view/s/veal/id/10838/","game":"https://order.syscoireland.com/catalog/category/view/s/game/id/10829/","other-poultry":"https://order.syscoireland.com/catalog/category/view/s/other-poultry/id/10820/","fresh-vegetables":"https://order.syscoireland.com/catalog/category/view/s/fresh-vegetables/id/10718/","fresh-fruit":"https://order.syscoireland.com/catalog/category/view/s/fresh-fruit/id/10754/","potato":"https://order.syscoireland.com/catalog/category/view/s/potato/id/10544/","frozen-vegetables":"https://order.syscoireland.com/catalog/category/view/s/frozen-vegetables/id/10517/","fries":"https://order.syscoireland.com/catalog/category/view/s/fries/id/10724/","prepared-veg":"https://order.syscoireland.com/catalog/category/view/s/prepared-veg/id/10481/","frozen-fruit":"https://order.syscoireland.com/catalog/category/view/s/frozen-fruit/id/10826/","fruit-veg-herbs":"https://order.syscoireland.com/catalog/category/view/s/fruit-veg-herbs/id/10760/","prepared-fruit":"https://order.syscoireland.com/catalog/category/view/s/prepared-fruit/id/10607/","fruit-veg-dried-fruit":"https://order.syscoireland.com/catalog/category/view/s/fruit-veg-dried-fruit/id/10757/","fruit-veg-other":"https://order.syscoireland.com/catalog/category/view/s/fruit-veg-other/id/10841/","speciality":"https://order.syscoireland.com/catalog/category/view/s/speciality/id/10895/","cheese":"https://order.syscoireland.com/catalog/category/view/s/cheese/id/10559/","milk":"https://order.syscoireland.com/catalog/category/view/s/milk/id/10670/","butter-spreads":"https://order.syscoireland.com/catalog/category/view/s/butter-spreads/id/10751/","eggs":"https://order.syscoireland.com/catalog/category/view/s/eggs/id/10763/","yoghurt":"https://order.syscoireland.com/catalog/category/view/s/yoghurt/id/10727/","cream":"https://order.syscoireland.com/catalog/category/view/s/cream/id/10643/","artisan-cheese":"https://order.syscoireland.com/catalog/category/view/s/artisan-cheese/id/10778/","everyday-essentials":"https://order.syscoireland.com/catalog/category/view/s/everyday-essentials/id/10943/","dairy-milk-eggs":"https://order.syscoireland.com/catalog/category/view/s/dairy-milk-eggs/id/10775/","buttermilk-sour":"https://order.syscoireland.com/catalog/category/view/s/buttermilk-sour/id/10802/","health-wellness":"https://order.syscoireland.com/catalog/category/view/s/health-wellness/id/11439/","cereal":"https://order.syscoireland.com/catalog/category/view/s/cereal/id/10868/","cheese-dairy-eggs-snacks":"https://order.syscoireland.com/catalog/category/view/s/cheese-dairy-eggs-snacks/id/10937/","protein":"https://order.syscoireland.com/catalog/category/view/s/protein/id/10949/","frozen-fish":"https://order.syscoireland.com/catalog/category/view/s/frozen-fish/id/10550/","fresh-fish":"https://order.syscoireland.com/catalog/category/view/s/fresh-fish/id/10817/","delicatessen":"https://order.syscoireland.com/catalog/category/view/s/delicatessen/id/10682/","salmon":"https://order.syscoireland.com/catalog/category/view/s/salmon/id/10901/","r-i-f-fish":"https://order.syscoireland.com/catalog/category/view/s/r-i-f-fish/id/23381/","deli-ready-meals-other":"https://order.syscoireland.com/catalog/category/view/s/deli-ready-meals-other/id/10733/","cooked-meat":"https://order.syscoireland.com/catalog/category/view/s/cooked-meat/id/10535/","pizza":"https://order.syscoireland.com/catalog/category/view/s/pizza/id/10613/","cooked-poultry":"https://order.syscoireland.com/catalog/category/view/s/cooked-poultry/id/10580/","hot-deli":"https://order.syscoireland.com/catalog/category/view/s/hot-deli/id/10742/","ready-meals":"https://order.syscoireland.com/catalog/category/view/s/ready-meals/id/10382/","canape-finger-food":"https://order.syscoireland.com/catalog/category/view/s/canape-finger-food/id/10721/","antipasti":"https://order.syscoireland.com/catalog/category/view/s/antipasti/id/10706/","charcuterie":"https://order.syscoireland.com/catalog/category/view/s/charcuterie/id/10859/","salads-fillings":"https://order.syscoireland.com/catalog/category/view/s/salads-fillings/id/10619/","soups":"https://order.syscoireland.com/catalog/category/view/s/soups/id/10592/","pate-terrine":"https://order.syscoireland.com/catalog/category/view/s/pate-terrine/id/10889/","bread":"https://order.syscoireland.com/catalog/category/view/s/bread/id/10484/","pastry-frozen":"https://order.syscoireland.com/catalog/category/view/s/pastry-frozen/id/10490/","pastry":"https://order.syscoireland.com/catalog/category/view/s/pastry/id/10787/","biscuits-cookies-bars":"https://order.syscoireland.com/catalog/category/view/s/biscuits-cookies-bars/id/10388/","cookies-doughnuts-muffins":"https://order.syscoireland.com/catalog/category/view/s/cookies-doughnuts-muffins/id/10475/","gluten-free":"https://order.syscoireland.com/catalog/category/view/s/gluten-free/id/10883/","croissants":"https://order.syscoireland.com/catalog/category/view/s/croissants/id/10772/","scones":"https://order.syscoireland.com/catalog/category/view/s/scones/id/10715/","bakery-savoury-other":"https://order.syscoireland.com/catalog/category/view/s/bakery-savoury-other/id/10736/","cakes-buns-cupcakes":"https://order.syscoireland.com/catalog/category/view/s/cakes-buns-cupcakes/id/10610/","baskets-nests":"https://order.syscoireland.com/catalog/category/view/s/baskets-nests/id/10805/","speciality-breads":"https://order.syscoireland.com/catalog/category/view/s/speciality-breads/id/22491/","crackers":"https://order.syscoireland.com/catalog/category/view/s/crackers/id/10622/","viennoiseries":"https://order.syscoireland.com/catalog/category/view/s/viennoiseries/id/10739/","scones-crumpets":"https://order.syscoireland.com/catalog/category/view/s/scones-crumpets/id/10965/","sweet-pastry":"https://order.syscoireland.com/catalog/category/view/s/sweet-pastry/id/11427/","sandwich-deli":"https://order.syscoireland.com/catalog/category/view/s/sandwich-deli/id/11403/","bakery-savoury-confectionery":"https://order.syscoireland.com/catalog/category/view/s/bakery-savoury-confectionery/id/11385/","pies-tarts":"https://order.syscoireland.com/catalog/category/view/s/pies-tarts/id/10790/","savoury-canape":"https://order.syscoireland.com/catalog/category/view/s/savoury-canape/id/25103/","bagels":"https://order.syscoireland.com/catalog/category/view/s/bagels/id/25185/","individual-mini-desserts":"https://order.syscoireland.com/catalog/category/view/s/individual-mini-desserts/id/25191/","cereals":"https://order.syscoireland.com/catalog/category/view/s/cereals/id/10439/","canned-veg":"https://order.syscoireland.com/catalog/category/view/s/canned-veg/id/10403/","spices-herbs":"https://order.syscoireland.com/catalog/category/view/s/spices-herbs/id/10487/","oil":"https://order.syscoireland.com/catalog/category/view/s/oil/id/10427/","pasta":"https://order.syscoireland.com/catalog/category/view/s/pasta/id/10661/","canned-tomato":"https://order.syscoireland.com/catalog/category/view/s/canned-tomato/id/10655/","jam-marmalade":"https://order.syscoireland.com/catalog/category/view/s/jam-marmalade/id/10436/","canned-dried-foods-dried-fruit":"https://order.syscoireland.com/catalog/category/view/s/canned-dried-foods-dried-fruit/id/10406/","sugar":"https://order.syscoireland.com/catalog/category/view/s/sugar/id/10667/","topping":"https://order.syscoireland.com/catalog/category/view/s/topping/id/10460/","rice":"https://order.syscoireland.com/catalog/category/view/s/rice/id/10562/","canned-fruit":"https://order.syscoireland.com/catalog/category/view/s/canned-fruit/id/10400/","canned-dried-foods-other":"https://order.syscoireland.com/catalog/category/view/s/canned-dried-foods-other/id/10793/","honey":"https://order.syscoireland.com/catalog/category/view/s/honey/id/10604/","canned-dried-foods-nuts":"https://order.syscoireland.com/catalog/category/view/s/canned-dried-foods-nuts/id/10640/","vinegar":"https://order.syscoireland.com/catalog/category/view/s/vinegar/id/10463/","pulses-seeds":"https://order.syscoireland.com/catalog/category/view/s/pulses-seeds/id/10511/","fruit-juices":"https://order.syscoireland.com/catalog/category/view/s/fruit-juices/id/10418/","hot-cold-beverages-soft-drinks":"https://order.syscoireland.com/catalog/category/view/s/hot-cold-beverages-soft-drinks/id/10448/","water":"https://order.syscoireland.com/catalog/category/view/s/water/id/10748/","coffee":"https://order.syscoireland.com/catalog/category/view/s/coffee/id/10472/","soft-drinks":"https://order.syscoireland.com/catalog/category/view/s/soft-drinks/id/10959/","tea":"https://order.syscoireland.com/catalog/category/view/s/tea/id/10589/","syrup":"https://order.syscoireland.com/catalog/category/view/s/syrup/id/10565/","hot-chocolate":"https://order.syscoireland.com/catalog/category/view/s/hot-chocolate/id/10649/","smoothies":"https://order.syscoireland.com/catalog/category/view/s/smoothies/id/10646/","hot-cold-beverages-other":"https://order.syscoireland.com/catalog/category/view/s/hot-cold-beverages-other/id/10568/","functional-drinks":"https://order.syscoireland.com/catalog/category/view/s/functional-drinks/id/10616/","ice-cream":"https://order.syscoireland.com/catalog/category/view/s/ice-cream/id/10664/","frozen-cakes":"https://order.syscoireland.com/catalog/category/view/s/frozen-cakes/id/10541/","tray-bakes":"https://order.syscoireland.com/catalog/category/view/s/tray-bakes/id/10514/","mini-desserts":"https://order.syscoireland.com/catalog/category/view/s/mini-desserts/id/10832/","tarts-pies":"https://order.syscoireland.com/catalog/category/view/s/tarts-pies/id/10553/","flavoured-toppings":"https://order.syscoireland.com/catalog/category/view/s/flavoured-toppings/id/10520/","desserts-cakes-other":"https://order.syscoireland.com/catalog/category/view/s/desserts-cakes-other/id/10469/","ice-cream-desserts":"https://order.syscoireland.com/catalog/category/view/s/ice-cream-desserts/id/10454/","sorbets":"https://order.syscoireland.com/catalog/category/view/s/sorbets/id/10694/","dessert-sauce":"https://order.syscoireland.com/catalog/category/view/s/dessert-sauce/id/10457/","ice-cream-decoration":"https://order.syscoireland.com/catalog/category/view/s/ice-cream-decoration/id/10808/","banqueting-slabs":"https://order.syscoireland.com/catalog/category/view/s/banqueting-slabs/id/10916/","quick-service-product":"https://order.syscoireland.com/catalog/category/view/s/quick-service-product/id/10874/","fresh-cakes":"https://order.syscoireland.com/catalog/category/view/s/fresh-cakes/id/10586/","ice-cream-cones":"https://order.syscoireland.com/catalog/category/view/s/ice-cream-cones/id/10814/","gluten-free-cake":"https://order.syscoireland.com/catalog/category/view/s/gluten-free-cake/id/23369/","yoghurt-frozen":"https://order.syscoireland.com/catalog/category/view/s/yoghurt-frozen/id/10598/","petits-fours":"https://order.syscoireland.com/catalog/category/view/s/petits-fours/id/10919/","disposables":"https://order.syscoireland.com/catalog/category/view/s/disposables/id/10508/","takeaway":"https://order.syscoireland.com/catalog/category/view/s/takeaway/id/10847/","hot-cups-lids":"https://order.syscoireland.com/catalog/category/view/s/hot-cups-lids/id/10850/","other-packaging":"https://order.syscoireland.com/catalog/category/view/s/other-packaging/id/10862/","cold-cups-lids":"https://order.syscoireland.com/catalog/category/view/s/cold-cups-lids/id/10844/","bakery":"https://order.syscoireland.com/catalog/category/view/s/bakery/id/10625/","deli":"https://order.syscoireland.com/catalog/category/view/s/deli/id/10856/","wrapping-systems":"https://order.syscoireland.com/catalog/category/view/s/wrapping-systems/id/10628/","mayonnaise":"https://order.syscoireland.com/catalog/category/view/s/mayonnaise/id/10442/","condiments-sauces":"https://order.syscoireland.com/catalog/category/view/s/condiments-sauces/id/10781/","ketchup":"https://order.syscoireland.com/catalog/category/view/s/ketchup/id/10697/","relish-chutneys":"https://order.syscoireland.com/catalog/category/view/s/relish-chutneys/id/10433/","mustards-pestos":"https://order.syscoireland.com/catalog/category/view/s/mustards-pestos/id/10784/","dressing":"https://order.syscoireland.com/catalog/category/view/s/dressing/id/10712/","condiments-other":"https://order.syscoireland.com/catalog/category/view/s/condiments-other/id/10688/","flour-yeast":"https://order.syscoireland.com/catalog/category/view/s/flour-yeast/id/10412/","chocolate":"https://order.syscoireland.com/catalog/category/view/s/chocolate/id/10658/","dessert-ingredients":"https://order.syscoireland.com/catalog/category/view/s/dessert-ingredients/id/10631/","sugars":"https://order.syscoireland.com/catalog/category/view/s/sugars/id/10601/","denatured-alcohol":"https://order.syscoireland.com/catalog/category/view/s/denatured-alcohol/id/10913/","purees-fresh-fruit":"https://order.syscoireland.com/catalog/category/view/s/purees-fresh-fruit/id/10685/","purees-frozen":"https://order.syscoireland.com/catalog/category/view/s/purees-frozen/id/10823/","stocks-sauces-sauces":"https://order.syscoireland.com/catalog/category/view/s/stocks-sauces-sauces/id/10424/","bouillon":"https://order.syscoireland.com/catalog/category/view/s/bouillon/id/10445/","stocks-sauces-other":"https://order.syscoireland.com/catalog/category/view/s/stocks-sauces-other/id/10466/","marinade-glazes":"https://order.syscoireland.com/catalog/category/view/s/marinade-glazes/id/10595/","bars":"https://order.syscoireland.com/catalog/category/view/s/bars/id/10502/","crisps":"https://order.syscoireland.com/catalog/category/view/s/crisps/id/10532/","confectionery-snacks":"https://order.syscoireland.com/catalog/category/view/s/confectionery-snacks/id/10703/","sweets":"https://order.syscoireland.com/catalog/category/view/s/sweets/id/10529/","tortilla":"https://order.syscoireland.com/catalog/category/view/s/tortilla/id/10700/","confectionery-nuts":"https://order.syscoireland.com/catalog/category/view/s/confectionery-nuts/id/10394/","confectionery-other":"https://order.syscoireland.com/catalog/category/view/s/confectionery-other/id/10538/","gum":"https://order.syscoireland.com/catalog/category/view/s/gum/id/10871/","mints":"https://order.syscoireland.com/catalog/category/view/s/mints/id/23358/","easter":"https://order.syscoireland.com/catalog/category/view/s/easter/id/10946/","savoury-snacks":"https://order.syscoireland.com/catalog/category/view/s/savoury-snacks/id/23364/","popcorn":"https://order.syscoireland.com/catalog/category/view/s/popcorn/id/23375/","healthier-snacks":"https://order.syscoireland.com/catalog/category/view/s/healthier-snacks/id/24372/","cleaning":"https://order.syscoireland.com/catalog/category/view/s/cleaning/id/10496/","hygiene":"https://order.syscoireland.com/catalog/category/view/s/hygiene/id/10499/","janitorial-safety":"https://order.syscoireland.com/catalog/category/view/s/janitorial-safety/id/10679/","cleaning-hygiene-other":"https://order.syscoireland.com/catalog/category/view/s/cleaning-hygiene-other/id/10886/","guest-amenities":"https://order.syscoireland.com/catalog/category/view/s/guest-amenities/id/10928/","kitchen-ware":"https://order.syscoireland.com/catalog/category/view/s/kitchen-ware/id/10577/","catering-essentials-other":"https://order.syscoireland.com/catalog/category/view/s/catering-essentials-other/id/10574/","baking-essentials":"https://order.syscoireland.com/catalog/category/view/s/baking-essentials/id/10898/","crockery":"https://order.syscoireland.com/catalog/category/view/s/crockery/id/10853/","cutlery":"https://order.syscoireland.com/catalog/category/view/s/cutlery/id/10865/","glassware":"https://order.syscoireland.com/catalog/category/view/s/glassware/id/10910/","table-top":"https://order.syscoireland.com/catalog/category/view/s/table-top/id/10652/","bar-accessories":"https://order.syscoireland.com/catalog/category/view/s/bar-accessories/id/10925/","cooking-wine":"https://order.syscoireland.com/catalog/category/view/s/cooking-wine/id/10676/","wine":"https://order.syscoireland.com/catalog/category/view/s/wine/id/10892/","alcohol-other":"https://order.syscoireland.com/catalog/category/view/s/alcohol-other/id/10904/","spirits":"https://order.syscoireland.com/catalog/category/view/s/spirits/id/10907/","beer":"https://order.syscoireland.com/catalog/category/view/s/beer/id/10934/","non-alcoholic":"https://order.syscoireland.com/catalog/category/view/s/non-alcoholic/id/10940/","port":"https://order.syscoireland.com/catalog/category/view/s/port/id/10953/","white-wine":"https://order.syscoireland.com/catalog/category/view/s/white-wine/id/11043/","red-wine":"https://order.syscoireland.com/catalog/category/view/s/red-wine/id/11046/","rose-wine":"https://order.syscoireland.com/catalog/category/view/s/rose-wine/id/11049/","champagne":"https://order.syscoireland.com/catalog/category/view/s/champagne/id/11052/","meat-alternatives":"https://order.syscoireland.com/catalog/category/view/s/meat-alternatives/id/10691/","soya-milk":"https://order.syscoireland.com/catalog/category/view/s/soya-milk/id/10637/","protein-powders":"https://order.syscoireland.com/catalog/category/view/s/protein-powders/id/10931/","fresh-and-frozen-produce":"https://order.syscoireland.com/new-product/fresh-and-frozen-produce.html","seafood":"https://order.syscoireland.com/new-product/seafood.html","centre-plate":"https://order.syscoireland.com/new-product/centre-plate.html","bakery-and-dessert":"https://order.syscoireland.com/new-product/bakery-and-dessert.html","dairy":"https://order.syscoireland.com/new-product/dairy.html","canned-and-dried":"https://order.syscoireland.com/new-product/canned-and-dried.html","beverage-and-impulse":"https://order.syscoireland.com/new-product/beverage-and-impulse.html","deli-and-ready-meals":"https://order.syscoireland.com/new-product/deli-and-ready-meals.html","meat-free":"https://order.syscoireland.com/new-product/meat-free.html","catering-essentials":"https://order.syscoireland.com/new-product/catering-essentials.html","world-food-canned-and-dried":"https://order.syscoireland.com/world-food-irl/world-food-canned-and-dried.html","world-food-condiments":"https://order.syscoireland.com/world-food-irl/world-food-condiments.html","world-food-cooking-sauces":"https://order.syscoireland.com/world-food-irl/world-food-cooking-sauces.html","world-food-cooking-ingredients":"https://order.syscoireland.com/world-food-irl/world-food-cooking-ingredients.html","world-food-bakery-and-dessert":"https://order.syscoireland.com/world-food-irl/world-food-bakery-and-dessert.html","world-food-deli-food":"https://order.syscoireland.com/world-food-irl/world-food-deli-food.html","world-food-cleaning-and-disposables":"https://order.syscoireland.com/world-food-irl/world-food-cleaning-and-disposables.html","world-food-meat-and-poultry":"https://order.syscoireland.com/world-food-irl/world-food-meat-and-poultry.html","world-food-fish-and-shellfish":"https://order.syscoireland.com/world-food-irl/world-food-fish-and-shellfish.html","world-food-frozen":"https://order.syscoireland.com/world-food-irl/world-food-frozen.html"}`;
// const stringTest = '{"beef":"https://order.syscoireland.com/catalog/category/view/s/beef/id/10796/"}'
const obj=JSON.parse(string);

export const getProductLinksFromCategories = functions
  .region("europe-west2").runWith({
    // Ensure the function has enough memory and time
    // to process large files
    timeoutSeconds: 540,
    memory: "4GB",
  })
  .https.onRequest(async (req, res) => {
    //initialize Puppeteer
    try {
      const browser = await puppeteer.launch();
    const page = await browser.newPage();
    page.setDefaultTimeout(540000);
    page.on("requestfailed", (request) => {
      console.log(request.url() + "" + request?.failure()?.errorText);
    });
    //start iterating through categories links
    for (var c in obj) {
      try {
        var categoryUrl = obj[c];
        await page.goto(categoryUrl);
        var hrefs = await page.evaluate(() => {
          //Get first page links
          var links = document.querySelectorAll("[class='product-item-link']");
          var hrefs = "";
          if (links == null) {
            return hrefs;
          }
          links.forEach((link) => {
            var href = link.getAttribute("href") + ",";
            hrefs += href;
          });
          return hrefs;
        });
        //get total page number
        await fsPromises.writeFile(__dirname+"/../../src/scrapeResult/"+c + ".txt", hrefs, { flag: "a+" });
        await fsPromises.writeFile(__dirname+"/../../src/scrapeResult/summary" + ".txt", hrefs, { flag: "a+" });
        let pages = await page.evaluate(() => {
          var elements = document.querySelectorAll("[class='toolbar-number']");
          if (elements != null) {
            if(elements.length==0){
              return 0;
            }
            var number = elements[0].innerHTML;
            return Math.ceil(Number(number) / 32);
          }
          return 0;
        });
        // console.log(pages);
        //get links on the rest of pages
        if (pages && pages > 1) {
          for (var pageIndex = 2; pageIndex <= pages; pageIndex++) {
            await page.goto(categoryUrl + "?p=" + pageIndex);
            let hrefs = await page.evaluate(() => {
              var links = document.querySelectorAll(
                "[class='product-item-link']"
              );
              var inside = "";
              links.forEach((link) => {
                var href = link.getAttribute("href") + ",";
                inside += href;
              });
              return inside;
            });
            await fsPromises.writeFile(__dirname+"/../../src/scrapeResult/"+c + ".txt", hrefs, { flag: "a+" });
            await fsPromises.writeFile(__dirname+"/../../src/scrapeResult/summary" + ".txt", hrefs, { flag: "a+" });
          }
        }
      } catch (error) {
        console.log(error);
        continue;
      }
    }
    await browser.close();
    } catch (error) {
      console.log(error);
    }
    
  });
